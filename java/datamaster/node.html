<html>

<head>

    <style>
        h3 {
            padding: 10px 0px;
            background: orangered;
            color: white;
            width: 100%;
        }
        span {
            font-size: 1.1em;
        }
        * {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif
        }

        body {
            margin: 0% 25%;
        }
        .container {}

        .host {
            color: red;
            font-size: 24;
        }

        td {
            padding: 5px;
        }

        .agentport,
        .logport,
        .cores,
        .availmem,
        .freemem,
        .starttime,
        .heartbeat {
            color: gray;
        }

        .process {
            margin: 1px;
            padding: 10px;
            border: solid 1px lightgray;
            background: lightgrey;
            width: inherit;
            display: block;
        }
        a {text-decoration: none;}
        .std { border-radius: 2px; padding: 2px 4px; color: white; font-weight: 200; }
        .errf { background: red; }
        .outf { background: green; }
    </style>

    <script>

        var nodename;
        var staticdata, container, host, agentport, logport, cores, availmem, freemem, starttime, heartbeat;

        function g(id) { return document.getElementById(id); }

        var elements = [
                ['agentport', 'Agent Port'],
                ['logport', 'Log Port'],
                ['cores', 'Cores'],
                ['availmem', 'Available Memory'],
                ['freemem', 'Free Memory'],
                ['starttime', 'Start Time'],
                ['heartbeat', 'Last Heartbeat']
            ];


        function prolog() {

        
            container = g("container");
            staticdata = g("staticdata");


            for(var i=0; i<elements.length; i++) {
                staticdata.innerHTML += 
                        `   <tr>
                                <td align='right'><span class='${elements[i][0]}'>${elements[i][1]}</span></td>
                                <td><span id='${elements[i][0]}'></span>
                            </tr>
                        `;
            }

            host = g("host");
            agentport = g("agentport");
            logport = g("logport");
            cores = g("cores");
            availmem = g("availmem");
            freemem = g("freemem");
            starttime = g("starttime");
            heartbeat = g("heartbeat");

            var params = (new URL(document.location)).searchParams;
            nodename = params.get("node");
            setAPIEndPoint("/status/slaves/" + nodename);
        }

        function set(x, v) { x.innerHTML = v; }

        function display(json) {

            set(host, nodename);
            set(agentport, json.agentPort);
            set(logport, json.logPort);
            set(cores, json.sysInfo.cores);
            set(availmem, btom(json.sysInfo.availableMemory));
            set(freemem, btom(json.sysInfo.freeMemory));
            set(starttime, dtos(json.sysInfo.startTime));
            set(heartbeat, dtos(json.lastHeartbeat));

            var logloc = `http://${json.host}:${json.logPort}`;
            container.innerHTML = "";
            for (var i = 0; i < json.processes.length; i++) {
                var gkey;
                var proc;
                Object.keys(json.processes[i]).forEach(function (key) {
                    gkey = key;
                });

                proc = json.processes[i][gkey];
                var plink = `node=${nodename}&process=${gkey}&loghost=${json.host}&logport=${json.logPort}`;
                container.innerHTML +=
                    `
                    <a href='process.html?${plink}' style='text-decoration: none; color: black;'>
                        <div class='process'>
                            <span>PID: </span><span>${proc.pid}</span>&nbsp;&nbsp;
                            <span>Type: </span><span>${proc.type}</span>&nbsp;&nbsp;
                            <span>Port: </span><span>${proc.port}</span>&nbsp;&nbsp;
                            <span>Last heartbeat: </span><span>${dtos(proc.lastHeartbeatTime)}</span>&nbsp;&nbsp;
                            <a href='${logloc}/${proc.errFile}' target='_blank'><span class='std errf'>stderr</span></a>&nbsp;&nbsp;
                            <a href='${logloc}/${proc.outFile}' target='_blank'><span class='std outf'>stdout</span></a>&nbsp;&nbsp;
                        </div>
                    </a>
                    `;
            }
        }
    </script>
    <script src="query.js"></script>
</head>

<body>
<center>
    <h3 id='host'></h3>

    <table id='staticdata'></table>
    <h4>Processes</h4>
    <div id='container'></div>
</center>
</body>

</html>